
# Домашнее задание к занятию «Микросервисы: принципы» - Барышков Михаил

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: API Gateway 

Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

Решение должно соответствовать следующим требованиям:
- маршрутизация запросов к нужному сервису на основе конфигурации,
- возможность проверки аутентификационной информации в запросах,
- обеспечение терминации HTTPS.

Обоснуйте свой выбор.

## Решение 1

### Сравнительная таблица решений API Gateway

| Решение | Маршрутизация | Аутентификация | HTTPS терминация | Балансировка | Мониторинг | Простота настройки | Производительность | Поддержка плагинов |
|---------|---------------|----------------|------------------|--------------|------------|-------------------|-------------------|-------------------|
| **NGINX** | ✅ | ✅ (через модули) | ✅ | ✅ | ✅ (статус) | Средняя | Очень высокая | ✅ |
| **Kong** | ✅ | ✅ (встроенная) | ✅ | ✅ | ✅ (Prometheus) | Средняя | Высокая | ✅✅ |
| **Traefik** | ✅ | ✅ (middleware) | ✅ | ✅ | ✅ (встроенный) | Высокая | Высокая | ✅ |
| **Envoy** | ✅ | ✅ (фильтры) | ✅ | ✅ | ✅ (статистика) | Сложная | Очень высокая | ✅✅ |
| **HAProxy** | ✅ | ✅ (ACL) | ✅ | ✅ | ✅ | Средняя | Очень высокая | ✅ |

### Выбор решения: **NGINX**

**Обоснование выбора:**

1. **Простота эксплуатации**: NGINX имеет простую и понятную конфигурацию с большим количеством примеров
2. **Стабильность**: Проверенное временем решение с высокой надежностью в production-средах
3. **Производительность**: Очень высокая производительность при минимальных ресурсах благодаря асинхронной архитектуре
4. **HTTPS терминация**: Встроенная поддержка SSL/TLS терминации с возможностью автоматического обновления сертификатов
5. **Гибкость**: Богатая экосистема модулей для расширения функциональности (Lua, JavaScript)
6. **Сообщество**: Большое сообщество, обширная документация и множество готовых решений
7. **Балансировка**: Встроенная поддержка различных алгоритмов балансировки нагрузки
8. **Аутентификация**: Возможность реализации проверки аутентификации через прокси-запросы (auth_request)

**Преимущества для наших требований:**
- Легко настраивается маршрутизация на основе location-блоков
- Модуль ngx_http_auth_request_module идеально подходит для проверки токенов через security-сервис
- Отличная поддержка HTTPS с минимальной конфигурацией
- Низкие задержки и высокий RPS

---

## Задача 2: Брокер сообщений

Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.

Решение должно соответствовать следующим требованиям:
- поддержка кластеризации для обеспечения надёжности,
- хранение сообщений на диске в процессе доставки,
- высокая скорость работы,
- поддержка различных форматов сообщений,
- разделение прав доступа к различным потокам сообщений,
- простота эксплуатации.

Обоснуйте свой выбор.

## Решение 2

### Сравнительная таблица брокеров сообщений

| Решение | Кластеризация | Сохранение на диск | Скорость | Форматы сообщений | Права доступа | Простота эксплуатации | Гарантия доставки |
|---------|---------------|-------------------|----------|-------------------|---------------|---------------------|-------------------|
| **RabbitMQ** | ✅✅ | ✅✅ | Высокая | JSON, XML, бинарные | ✅✅ | Средняя | ✅✅ |
| **Apache Kafka** | ✅✅ | ✅✅ | Очень высокая | Бинарный | ✅✅ | Сложная | ✅✅ |
| **Redis Pub/Sub** | ✅ | ❌ | Очень высокая | Простые типы | ✅ | Простая | ❌ |
| **NATS** | ✅✅ | ✅ (JetStream) | Очень высокая | Текст/бинарный | ✅ | Простая | ✅ |
| **ActiveMQ** | ✅ | ✅ | Средняя | Множество | ✅✅ | Средняя | ✅✅ |

### Выбор решения: **RabbitMQ**

**Обоснование выбора:**

1. **Надежность и гарантии доставки**: 
   - Подтверждение получения сообщений
   - Сохранение сообщений на диск
   - Поддержка транзакций

2. **Кластеризация**: 
   - Отличная поддержка кластеризации для высокой доступности
   - Mirroring очередей между узлами
   - Автоматическое восстановление при сбоях

3. **Гибкость коммуникации**: 
   - Поддержка различных паттернов (point-to-point, pub/sub, work queues)
   - Гибкая маршрутизация через exchange types (direct, topic, fanout, headers)

4. **Безопасность**: 
   - Гибкая система прав доступа к очередям, обменникам и виртуальным хостам
   - Поддержка SSL/TLS
   - Аутентификация и авторизация

5. **Простота эксплуатации**: 
   - Веб-интерфейс для мониторинга и управления
   - Подробные метрики и статистика
   - Понятные инструменты для диагностики

6. **Поддержка форматов**: 
   - Работа с различными форматами сообщений через плагины
   - Простая интеграция с различными языками программирования

7. **Производительность**: 
   - Высокая скорость работы при сохранении надежности
   - Эффективное использование ресурсов
   - Поддержка персистентных и транзиентных сообщений

**Соответствие требованиям:**
- ✅ **Кластеризация**: Нативная поддержка кластеров с высокой доступностью
- ✅ **Сохранение на диск**: Durable queues и persistent messages
- ✅ **Высокая скорость**: Оптимизированная производительность для enterprise-использования
- ✅ **Различные форматы**: Поддержка любых форматов через свойства сообщений
- ✅ **Права доступа**: Детальная система разрешений на уровне vhost/queue/exchange
- ✅ **Простота эксплуатации**: Удобный UI и инструменты мониторинга

**Дополнительные преимущества:**
- Широкая экосистема и поддержка сообщества
- Хорошая документация и множество готовых решений
- Поддержка плагинов для расширения функциональности
- Протокол AMQP 0-9-1 как отраслевой стандарт

## Задача 3: API Gateway * (необязательная)

### Есть три сервиса:

**minio**
- хранит загруженные файлы в бакете images,
- S3 протокол,

**uploader**
- принимает файл, если картинка сжимает и загружает его в minio,
- POST /v1/upload,

**security**
- регистрация пользователя POST /v1/user,
- получение информации о пользователе GET /v1/user,
- логин пользователя POST /v1/token,
- проверка токена GET /v1/token/validation.

### Необходимо воспользоваться любым балансировщиком и сделать API Gateway:

**POST /v1/register**
1. Анонимный доступ.
2. Запрос направляется в сервис security POST /v1/user.

**POST /v1/token**
1. Анонимный доступ.
2. Запрос направляется в сервис security POST /v1/token.

**GET /v1/user**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис security GET /v1/user.

**POST /v1/upload**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис uploader POST /v1/upload.

**GET /v1/user/{image}**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис minio GET /images/{image}.

### Ожидаемый результат

Результатом выполнения задачи должен быть docker compose файл, запустив который можно локально выполнить следующие команды с успешным результатом.
Предполагается, что для реализации API Gateway будет написан конфиг для NGinx или другого балансировщика нагрузки, который будет запущен как сервис через docker-compose и будет обеспечивать балансировку и проверку аутентификации входящих запросов.
Авторизация
curl -X POST -H 'Content-Type: application/json' -d '{"login":"bob", "password":"qwe123"}' http://localhost/token

**Загрузка файла**

curl -X POST -H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJib2IifQ.hiMVLmssoTsy1MqbmIoviDeFPvo-nCd92d4UFiN2O2I' -H 'Content-Type: octet/stream' --data-binary @yourfilename.jpg http://localhost/upload

**Получение файла**
curl -X GET http://localhost/images/4e6df220-295e-4231-82bc-45e4b1484430.jpg

---

#### [Дополнительные материалы: как запускать, как тестировать, как проверить](https://github.com/netology-code/devkub-homeworks/tree/main/11-microservices-02-principles)

---

### Как оформить ДЗ?

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---
